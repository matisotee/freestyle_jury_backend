language: python
python:
  - "3.8.3"
sudo: required
services:
  - docker
cache: pip
before_install:
  # install heroku CLI
  - wget -qO- https://toolbelt.heroku.com/install.sh | sh
  # login to docker registries
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - echo "$HEROKU_PASSWORD" | docker login -u "$HEROKU_USERNAME" --password-stdin registry.heroku.com

# command to install dependencies
install:
  - pip install -r requirements.txt
# command to run tests
jobs:
  include:
    - stage: Unit Test
      script: coverage run --source='.' ./manage.py test test/unit
    # - stage name not required, will continue to use `test`
      after_success: coveralls
    - stage: Integration Test
      script: coverage run --source='.' ./manage.py test test/integration
    - stage: Build image, save and deploy
      if: branch = master AND type = push
      script:
         #build and push image
        - docker build -t freestyle-jury-api .
        - docker tag freestyle-jury-api $DOCKER_USERNAME/freestyle-jury-api-qa:$TRAVIS_TAG
        - docker push $DOCKER_USERNAME/freestyle-jury-api-qa:$TRAVIS_TAG
        - docker tag freestyle-jury-api $DOCKER_USERNAME/freestyle-jury-api-qa:latest
        - docker push $DOCKER_USERNAME/freestyle-jury-api-qa:latest
        - docker tag freestyle-jury-api registry.heroku.com/$HEROKU_APP_NAME/web
        - docker push registry.heroku.com/$HEROKU_APP_NAME/web
        - heroku container:release web --app $HEROKU_APP_NAME
branches:
  only:
    - master
#script:
#  - coverage run --source='.' ./manage.py test
#after_success:
#  - coveralls
